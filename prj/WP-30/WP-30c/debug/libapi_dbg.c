/***************** (C) COPYRIGHT 2014 START Computer equipment *****************
 * File Name          : libapi_dbg.c
 * bfief              : 
 * Author             : luocs()  
 * Email              : luocs@itep.com.cn
 * Version            : V0.00
 * Date               : 11/26/2014 5:42:34 PM
 * Description        : 
 *******************************************************************************/
#include "wp30_ctrl.h"
#include "../libdll/libdll.h"
#include "libapi_dbg.h"

#if defined (CFG_LIBAPI_DEBUG)

#ifdef CFG_LIBAPI_DBG_LCD 
//const uchar startlog[] =
//{
//    /* 宽度 * 高度 = 120 * 41 */
//    0x42,0x4d ,0xce,0x02 ,0x00,0x00 ,0x00,0x00 ,0x00,0x00 ,0x3e,0x00 ,0x00,0x00 ,0x28,0x00,
//    0x00,0x00 ,0x78,0x00 ,0x00,0x00 ,0x29,0x00 ,0x00,0x00 ,0x01,0x00 ,0x01,0x00 ,0x00,0x00,
//    0x00,0x00 ,0x90,0x02 ,0x00,0x00 ,0x00,0x00 ,0x00,0x00 ,0x00,0x00 ,0x00,0x00 ,0x00,0x00,
//    0x00,0x00 ,0x00,0x00 ,0x00,0x00 ,0x00,0x00 ,0x00,0x00 ,0xff,0xff ,0xff,0x00 ,0xff,0xff,
//    0xff,0xff ,0xff,0xff ,0xff,0xff ,0xff,0xff ,0xff,0xff ,0xff,0xff ,0xff,0x00 ,0xff,0xff,
//    0xff,0xff ,0xff,0xff ,0xff,0xff ,0xff,0xff ,0xff,0xff ,0xff,0xff ,0xff,0x00 ,0xff,0xff,
//    0xff,0xfc ,0x03,0xc0 ,0xff,0xff ,0x03,0x07 ,0xc0,0xfc ,0x03,0xe0 ,0x7f,0x00 ,0xff,0xff,
//    0xf0,0x00 ,0x01,0xc0 ,0x7f,0xff ,0x03,0x03 ,0xc0,0xfc ,0x03,0xe0 ,0x7f,0x00 ,0xff,0xff,
//    0xe0,0x00 ,0x00,0xc0 ,0x1f,0xff ,0x03,0x03 ,0xc0,0xf8 ,0x03,0xe0 ,0x7f,0x00 ,0xff,0x80,
//    0x00,0x00 ,0x00,0x70 ,0x0f,0xff ,0x81,0x81 ,0xe0,0xe0 ,0x3f,0xf0 ,0x3f,0x00 ,0xf0,0x00,
//    0x00,0x00 ,0x00,0x38 ,0x0f,0xff ,0x81,0xc0 ,0x80,0xc0 ,0x1f,0xf0 ,0x3f,0x00 ,0xe0,0x00,
//    0x00,0x00 ,0x00,0x3c ,0x07,0xff ,0x81,0xc0 ,0x80,0x40 ,0x03,0xf0 ,0x3f,0x00 ,0xc7,0xff,
//    0xff,0xff ,0xf0,0x1e ,0x03,0xff ,0x81,0xe0 ,0x00,0x40 ,0x01,0xf0 ,0x3f,0x00 ,0x8f,0xff,
//    0xff,0xff ,0xf8,0x1f ,0x01,0xff ,0x80,0xf0 ,0x60,0x40 ,0x01,0xf0 ,0x1f,0x00 ,0x8f,0xc0,
//    0x00,0x7f ,0xf8,0x1f ,0x80,0xff ,0xc0,0xf0 ,0x30,0x7f ,0xe1,0xf8 ,0x1f,0x00 ,0x8f,0xc0,
//    0x00,0x0f ,0xf8,0x1f ,0xc0,0x7f ,0xc0,0xf8 ,0x10,0x3f ,0xe1,0xf8 ,0x1f,0x00 ,0xcf,0xc0,
//    0x00,0x01 ,0xfc,0x1f ,0xc0,0x02 ,0x00,0x04 ,0x00,0x20 ,0x01,0x80 ,0x01,0x00 ,0xcf,0xe0,
//    0x00,0x01 ,0xfc,0x1f ,0xe0,0x02 ,0x00,0x04 ,0x00,0x20 ,0x01,0x80 ,0x01,0x00 ,0xc7,0xe0,
//    0x00,0x00 ,0xfc,0x1f ,0xf8,0x02 ,0x00,0x06 ,0x00,0x20 ,0x03,0x80 ,0x01,0x00 ,0xe7,0xe0,
//    0x00,0x00 ,0x1e,0x0f ,0xfc,0x02 ,0x00,0x07 ,0x00,0x20 ,0x07,0x80 ,0x01,0x00 ,0xe7,0xe0,
//    0x00,0x00 ,0x1f,0x0f ,0xff,0xff ,0xff,0xff ,0xff,0xff ,0xff,0xff ,0xff,0x00 ,0xe3,0xf0,
//    0x7f,0xf8 ,0x1f,0x0f ,0xff,0xff ,0xff,0xff ,0xff,0xff ,0xff,0xff ,0xff,0x00 ,0xf3,0xf0,
//    0xff,0xfe ,0x1f,0x0f ,0xff,0xff ,0xff,0xff ,0xff,0xff ,0xff,0xff ,0xff,0x00 ,0xf1,0xf0,
//    0xff,0xfe ,0x1f,0x0f ,0xf0,0x00 ,0x7f,0x00 ,0x00,0x00 ,0x00,0x00 ,0x1f,0x00 ,0xf9,0xf1,
//    0xc1,0xe0 ,0x1f,0x87 ,0xf8,0x00 ,0x3e,0x00 ,0x00,0x00 ,0x00,0x00 ,0x0f,0x00 ,0xf9,0xfb,
//    0x87,0x00 ,0x7f,0x87 ,0xf8,0x00 ,0x1c,0x00 ,0x00,0x00 ,0x00,0x00 ,0x0f,0x00 ,0xf8,0xfb,
//    0x1e,0x00 ,0xff,0x87 ,0xff,0xfc ,0x08,0x1f ,0xff,0x83 ,0xff,0xff ,0xff,0x00 ,0xfc,0xfa,
//    0x10,0x07 ,0xff,0xc7 ,0xff,0xfc ,0x07,0xff ,0xff,0x82 ,0x01,0xf8 ,0x1f,0x00 ,0xfc,0xfe,
//    0x3f,0xff ,0xff,0xc7 ,0xfc,0x00 ,0x00,0x00 ,0x0f,0xc3 ,0x01,0xf8 ,0x1f,0x00 ,0xfc,0x7e,
//    0x1f,0xff ,0xef,0xc3 ,0xfc,0x00 ,0x00,0x00 ,0x0f,0xc1 ,0x80,0xf8 ,0x1f,0x00 ,0xfe,0x7e,
//    0x0f,0xff ,0xc7,0xe3 ,0xfc,0x00 ,0x00,0x00 ,0x0f,0xc0 ,0xc0,0x78 ,0x3f,0x00 ,0xfe,0x7e,
//    0x07,0xff ,0x83,0xe3 ,0xff,0xff ,0xe0,0x3f ,0xff,0xc0 ,0xe0,0x30 ,0x7f,0x00 ,0xfe,0x3f,
//    0x00,0x00 ,0x03,0xe1 ,0xfe,0x00 ,0x30,0x1f ,0xff,0xe0 ,0xf0,0x10 ,0x7f,0x00 ,0xff,0x3f,
//    0x80,0x00 ,0x01,0xf1 ,0xfe,0x00 ,0x18,0x0f ,0xff,0xe0 ,0xf8,0x00 ,0xff,0x00 ,0xff,0x3f,
//    0xc0,0x00 ,0x01,0xf1 ,0xff,0xff ,0xfc,0x07 ,0x87,0xe0 ,0x7c,0x00 ,0xff,0x00 ,0xff,0x1f,
//    0xf0,0x00 ,0x01,0xf8 ,0xff,0x06 ,0x06,0x03 ,0x87,0xe0 ,0x7e,0x00 ,0xff,0x00 ,0xff,0x9f,
//    0xfe,0x00 ,0x00,0xf8 ,0xff,0x06 ,0x03,0x01 ,0x83,0xf0 ,0x7e,0x07 ,0xff,0x00 ,0xff,0x8f,
//    0xff,0xc0 ,0x00,0xf8 ,0xff,0x03 ,0xff,0xff ,0x83,0xf0 ,0x7f,0x03 ,0xff,0x00 ,0xff,0xcf,
//    0xff,0xf0 ,0x00,0x78 ,0xff,0x00 ,0x00,0x00 ,0x01,0xc0 ,0x20,0x00 ,0x03,0x00 ,0xff,0xcf,
//    0xff,0xfe ,0x00,0x71 ,0xff,0x80 ,0x00,0x00 ,0x01,0xc0 ,0x20,0x00 ,0x03,0x00 ,0xff,0xc7,
//    0xff,0xff ,0xff,0x61 ,0xff,0x80 ,0x00,0x00 ,0x01,0xc0 ,0x20,0x00 ,0x03,0x00 ,0xff,0xe7,
//    0xff,0xff ,0xff,0xc7 ,0xff,0xff ,0xf8,0x0f ,0xff,0xf8 ,0x7f,0x81 ,0xff,0x00 ,0xff,0xe0,
//    0x00,0x00 ,0x00,0x07 ,0xff,0xff ,0xfc,0x07 ,0xff,0xf8 ,0x7f,0xc0 ,0xff,0x00 ,0xff,0xf0,
//    0x00,0x00 ,0x00,0x0f ,0xff,0xff ,0xfe,0x03 ,0xff,0xf8 ,0x7f,0xe0 ,0x7f,0x00 ,0xff,0xff,
//    0xff,0xff ,0xff,0xff ,0xff,0xff ,0xff,0xff ,0xff,0xff ,0xff,0xff ,0xff,0x00 ,0x0d,0x00
//};
//
//
//uint8_t gcDefaultLogo[256]=
//{
//	/*--  调入了一幅图像：C:\Documents and Settings\Administrator\桌面\Untitle.bmp  --*/
//	/*--  宽度x高度=53x32  --*/
//	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x07,0x3F,0x7F,0x7F,0xFF,0xFF,0xFF,
//	0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
//	0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
//	0xFF,0xFF,0xFF,0x7F,0x3F,0x00,0x00,0x00,0x00,0x00,0x03,0x0F,0x3F,0xFF,0xEF,0xD3,
//	0x10,0x30,0xB3,0xB3,0xBF,0xFF,0x00,0x00,0x25,0x25,0x25,0x01,0x01,0xFF,0xFF,0xFF,
//	0xFF,0xFF,0xBF,0x80,0xB3,0xB3,0x80,0x80,0xBF,0x4E,0x0E,0x80,0xC0,0x80,0x0E,0xCE,
//	0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFE,0xF8,0xC0,0x00,0x00,0x00,0x07,0x1F,0x7F,0xFF,
//	0xFF,0xFF,0xFF,0xFF,0x3F,0x01,0x01,0x39,0x3B,0xFF,0xFF,0x01,0x01,0xFD,0x87,0x93,
//	0x99,0x99,0xFF,0xFF,0xFF,0xFF,0xFF,0xF7,0x07,0x37,0x37,0x01,0x01,0xF7,0x7D,0x63,
//	0x07,0x1F,0x07,0x63,0x79,0xFF,0xFF,0xFF,0xFC,0xF0,0xC0,0x00,0x00,0x00,0x00,0x3C,
//	0xFE,0xFE,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
//	0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
//	0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFE,0xFE,0xF8,0xE0,0x00,0x00,0x00,0x00,
//	0x00,0x00,0x00,0x00
//};

void dbg_libapi_lcd(void)
{
    int key;
    int iRet;
    while (1)
    {
        TRACE("\r\n-|******************libapi lcd**********************|-");
        TRACE("\r\n-|1-bcklight 2-display 3-flash 4-rtc 5-rnga             |-");
        TRACE("\r\n-|******************************************************|-\t");
        key = InkeyCount(0);
        drv_lcd_cls();
        switch (key)
        {
        case 1:
            TRACE("\n-|1-temp 2-定时模式 3-常开 4-常关");
            key = InkeyCount(0)-1;
            iRet = lcd_SetLight(key);
            break;
        case 2:
            lcd_Display(0,FONT_SIZE12*0,FONT_SIZE12|DISP_MEDIACY|DISP_INVLINE,"你HELLO");
            lcd_Display(0,FONT_SIZE12*2,FONT_SIZE12|DISP_MEDIACY|DISP_INVLINE,"HELLO好");
            lcd_Display(0,FONT_SIZE12*3,FONT_SIZE12|DISP_MEDIACY|DISP_INVLINE,"H你ELLO好");
            break;
//        case 3:
//            lcd_bmp_disp(4, 11, startlog);
//            break;
//        case 4:
//            lcd_bmpmap_disp(0,0,53,32,gcDefaultLogo);
//            break;
        case 5:
            break;
        case 6:
            break;
        case 99:
            return;
        default:
            break;
        }
        TRACE("\n|iRet:%d 0x%04X",iRet,iRet);
    }

}
#endif

#ifdef CFG_LIBAPI_DBG_MAG
void dbg_libapi_magtek(void)
{
    int magret = 0x70;
    uchar track[3][128];
//    mag_init(0);
    TRACE("\r\n magret test");
    sys_BeepPro(BEEP_PWM_HZ,1000,1);
    mag_Open();
    while ( 1 ) {
        if ( IfInkey(0) ) {
            break;
        }
        if ( mag_Check() ) {
            memset(track,0,sizeof(track));
            TRACE("\r\n magret read");
            magret = mag_Read(track[0], track[1], track[2]);
            TRACE("\r\n magret:%x",magret);
//            DISPBUF("track1",(magret>>8)&0xFF,0,track[0]);
            DISPBUF("track2",(magret>>16)&0xFF,2,track[1]);
            DISPBUF("track3",(magret>>24)&0xFF,2,track[2]);
            sys_Beep();
        }
    }
    mag_Close();
}
#endif

#ifdef CFG_LIBAPI_DBG_RFID
void dbg_libapi_rfid(void)
{
    int ret,type,len;
    uchar buf[64];
    TRACE("\r\n rfid test :%d",rfid_open(0));
    ret = rfid_poll(RFID_MODE_ISO,(uint*)&type);
    if ( !ret ) {
        ret = rfid_powerup(type,(uint*)&len,buf);
        if ( !ret ) {
            ret = rfid_exchangedata(5,"\x00\x84\x00\x00\x04",(uint *)&len,buf);
            if ( !ret ) {
                TRACE("\r\n random success");
                DISPBUF("random",len,0,buf);
                sys_BeepPro(BEEP_PWM_HZ,1000,1);
            }else
                TRACE("\r\n random error");
        }else
            TRACE("\r\n powerup error");
    }else{
        TRACE("\r\n poll error");
    }
    rfid_close();
}
#endif

const uint8_t gcShatest[] = {
    0xA0,0x00,0x00,0x03,0x33,0x01,0xBB,0xE9,0x06,0x6D,0x25,0x17,0x51,0x1D,0x23,0x9C,0x7B,0xFA,0x77,0x88,0x41,0x44,0xAE,
    0x20,0xC7,0x37,0x2F,0x51,0x51,0x47,0xE8,0xCE,0x65,0x37,0xC5,0x4C,0x0A,0x6A,0x4D,
    0x45,0xF8,0xCA,0x4D,0x29,0x08,0x70,0xCD,0xA5,0x9F,0x13,0x44,0xEF,0x71,0xD1,0x7D,
    0x3F,0x35,0xD9,0x2F,0x3F,0x06,0x77,0x8D,0x0D,0x51,0x1E,0xC2,0xA7,0xDC,0x4F,0xFE,
    0xAD,0xF4,0xFB,0x12,0x53,0xCE,0x37,0xA7,0xB2,0xB5,0xA3,0x74,0x12,0x27,0xBE,0xF7,
    0x25,0x24,0xDA,0x7A,0x2B,0x7B,0x1C,0xB4,0x26,0xBE,0xE2,0x7B,0xC5,0x13,0xB0,0xCB,
    0x11,0xAB,0x99,0xBC,0x1B,0xC6,0x1D,0xF5,0xAC,0x6C,0xC4,0xD8,0x31,0xD0,0x84,0x87,
    0x88,0xCD,0x74,0xF6,0xD5,0x43,0xAD,0x37,0xC5,0xA2,0xB4,0xC5,0xD5,0xA9,0x3B, 0x03
};

void dbg_libapi_hash(void)
{
    uint8_t result[20];

    Hash(gcShatest,sizeof(gcShatest),result);
    TRACE_BUF("src",gcShatest,sizeof(gcShatest));
    TRACE_BUF("reult",result,20);
}

void dbg_libapi_main(void)
{
    int key;
    while (1)
    {
        TRACE("\r\n-|******************libapi debug*********************|-");
        TRACE("\r\n-|1-lcd 2-magtek 3-flash 4-rtc 5-rnga 6-security     |-");
        TRACE("\r\n-|7-rfid                                             |-");
        TRACE("\r\n-|***************************************************|-\t");
        key = InkeyCount(0);
        switch (key)
        {
#ifdef CFG_LIBAPI_DBG_LCD 
        case 1:
            dbg_libapi_lcd();
            break;
#endif
#ifdef CFG_LIBAPI_DBG_MAG
        case 2:
            dbg_libapi_magtek();
            break;
#endif
        case 3:
            dbg_libapi_hash();
            break;
#ifdef CFG_LIBAPI_DBG_RFID
        case 7:
            dbg_libapi_rfid();
            break;
#endif
        case 99:
            TRACE("\r\n");
            return;
        default:
            break;
        }
    }
}

#endif

